import os
# РюЁ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЌ рЃАрЃгрЃЮрЃарЃў рЃўрЃЏрЃърЃЮрЃарЃбрЃў
from langchain_chroma import Chroma 
from langchain_community.document_loaders import PyPDFDirectoryLoader
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter 
# ­ЪЏЉ рЃЏрЃЮрЃФрЃЋрЃћрЃџрЃћрЃЉрЃБрЃџрЃў рЃўрЃЏрЃърЃЮрЃарЃбрЃў: # from langchain_community.vectorstores import Chroma

# --- рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ ---
DATA_DIR = "Steam"  
CHROMA_PATH = "chroma_db" 

# ----------------------------------------------------------------------------------
# --- рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃћрЃЉрЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ ENVIRONMENT VARIABLES-рЃўрЃЊрЃљрЃю (рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮ) ---
# ----------------------------------------------------------------------------------
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY") 

# ----------------------------------------------------
# API рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃўрЃА рЃўрЃФрЃБрЃџрЃћрЃЉрЃўрЃЌрЃў рЃЊрЃљрЃДрЃћрЃюрЃћрЃЉрЃљ
# ----------------------------------------------------
if OPENAI_API_KEY:
    os.environ["OPENAI_API_KEY"] = OPENAI_API_KEY
# ----------------------------------------------------

def ingest_data():
    """
    рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃА PDF-рЃћрЃЉрЃА, рЃДрЃЮрЃцрЃА рЃбрЃћрЃЦрЃАрЃбрЃА (chunking), рЃЋрЃћрЃЦрЃбрЃЮрЃарЃўрЃќрЃљрЃфрЃўрЃљрЃА рЃБрЃЎрЃћрЃЌрЃћрЃЉрЃА рЃЊрЃљ рЃўрЃюрЃљрЃ«рЃљрЃЋрЃА ChromaDB-рЃерЃў.
    """
    # 1. рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ (рЃБрЃфрЃЋрЃџрЃћрЃџрЃў)
    print(f"--- 1. рЃЊрЃљрЃгрЃДрЃћрЃЉрЃБрЃџрЃўрЃљ рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ рЃАрЃљрЃЦрЃљрЃдрЃљрЃџрЃЊрЃўрЃЊрЃљрЃю: {DATA_DIR} ---")
    
    if not os.path.exists(DATA_DIR):
        print(f" рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: рЃАрЃљрЃЦрЃљрЃдрЃљрЃџрЃЊрЃћ '{DATA_DIR}' рЃЋрЃћрЃа рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ. рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ, рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃЮрЃЌ рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў.")
        return

    try:
        loader = PyPDFDirectoryLoader(DATA_DIR)
        documents = loader.load()
    except Exception as e:
        print(f" рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃћрЃЉрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃўрЃАрЃљрЃА: {e}")
        return

    if not documents:
        print(f" рЃљрЃарЃфрЃћрЃарЃЌрЃў рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃў рЃљрЃа рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ рЃўрЃюрЃЊрЃћрЃЦрЃАрЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА рЃАрЃљрЃЦрЃљрЃдрЃљрЃџрЃЊрЃћрЃерЃў: {DATA_DIR}.")
        return
        
    print(f" рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ {len(documents)} рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃў рЃгрЃљрЃАрЃљрЃЎрЃўрЃЌрЃ«рЃљрЃЊ.")

    # 2. рЃбрЃћрЃЦрЃАрЃбрЃўрЃА рЃЊрЃљрЃДрЃЮрЃцрЃљ (Chunking) (рЃБрЃфрЃЋрЃџрЃћрЃџрЃў)
    print("--- 2. рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћрЃЮрЃЉрЃА рЃбрЃћрЃЦрЃАрЃбрЃўрЃА рЃцрЃарЃљрЃњрЃЏрЃћрЃюрЃбрЃћрЃЉрЃљрЃЊ рЃЊрЃљрЃДрЃЮрЃцрЃљ (Chunking) ---")
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=1000, 
        chunk_overlap=200
    )
    texts = text_splitter.split_documents(documents)
    print(f"рЃерЃћрЃЦрЃЏрЃюрЃўрЃџрЃўрЃљ {len(texts)} рЃбрЃћрЃЦрЃАрЃбрЃБрЃарЃў рЃцрЃарЃљрЃњрЃЏрЃћрЃюрЃбрЃў (chunk).")

    # 3. рЃЋрЃћрЃЦрЃбрЃЮрЃарЃўрЃќрЃљрЃфрЃўрЃљ рЃЊрЃљ рЃерЃћрЃюрЃљрЃ«рЃЋрЃљ (ChromaDB)
    print("--- 3. рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћрЃЮрЃЉрЃА рЃЋрЃћрЃЦрЃбрЃЮрЃарЃўрЃќрЃљрЃфрЃўрЃљ (Embedding) рЃЊрЃљ рЃерЃћрЃюрЃљрЃ«рЃЋрЃљ ChromaDB-рЃерЃў ---")
    
    #  рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ, рЃарЃЮрЃЏ рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃў рЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃљрЃЊ рЃЕрЃљрЃўрЃбрЃЋрЃўрЃарЃЌрЃљ рЃњрЃљрЃарЃћрЃЏрЃЮрЃЊрЃљрЃю
    if not OPENAI_API_KEY:
          print(" ERROR: OpenAI API рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃў рЃЋрЃћрЃа рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ рЃЋрЃћрЃЦрЃбрЃЮрЃарЃўрЃќрЃљрЃфрЃўрЃўрЃАрЃЌрЃЋрЃўрЃА. рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ Environment Variables.")
          return
          
    embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
    
    # рЃЋрЃћрЃЦрЃбрЃЮрЃарЃБрЃџрЃў рЃЉрЃљрЃќрЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ рЃЊрЃљ рЃерЃћрЃюрЃљрЃ«рЃЋрЃљ
    # РюЁ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЉрЃљ рЃљрЃ«рЃљрЃџрЃў Chroma рЃЎрЃџрЃљрЃАрЃў
    Chroma.from_documents(
        texts,
        embeddings,
        persist_directory=CHROMA_PATH
    )
    
    print(f" рЃўрЃюрЃЊрЃћрЃЦрЃАрЃўрЃарЃћрЃЉрЃљ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ. рЃЋрЃћрЃЦрЃбрЃЮрЃарЃБрЃџрЃў рЃЉрЃљрЃќрЃљ рЃерЃћрЃюрЃљрЃ«рЃБрЃџрЃўрЃљ: {CHROMA_PATH}")

if __name__ == "__main__":
    ingest_data()
